---
- name: Create horcrux directory
  file:
    owner: '{{ horcrux_user }}'
    group: '{{ horcrux_user }}'
    state: directory
    path: '{{ horcrux_dir }}'
    mode: '0750'

- name: Create state files
  template:
    src: priv_validator_state.json
    dest: "{{ horcrux_dir }}/state/{{ chain_id }}_{{ item }}"
    mode: '0600'
    owner: "{{ horcrux_user }}"
    group: "{{ horcrux_user }}"
    force: no
  with_items:
    - priv_validator_state.json
    - share_sign_state.json

- name: Copy horcrux service file
  become: true
  template:
    src: 'horcrux.service.j2'
    dest: '/etc/systemd/system/{{ service_file }}'
    owner: root
    group: root
    mode: 600

- name: Generate private keys
  local_action: command make genkeys
  run_once: True

- name: Copy keys
  copy:
    src: "keys/private_share_{{ signorder }}.json"
    dest: "{{ horcrux_dir }}/share.json"
    owner: "{{ horcrux_user }}"
    group: "{{ horcrux_user }}"
    mode: '0400'
